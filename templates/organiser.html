<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Management Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        :root {
            --primary-color: #052d14;
            --secondary-color: #087d04;
            --accent-color: #4adb34;
            --success-color: #052d14;
            --background-color: #ecf0f1;
            --card-background: #ffffff;
        }

        body {
            background-color: var(--background-color);
            color: var(--primary-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-top: 100px;
        }

        nav {
            background: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        nav a {
            color: white !important;
            transition: all 0.3s ease;
            padding: 0.7rem 1.2rem !important;
            border-radius: 5px;
            margin: 0 0.5rem;
        }

        nav a:hover {
            background: #555;;
            transform: translateY(-2px);
        }

        .container {
            background: var(--card-background);
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .profile-section {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
        }

        .profile-info {
            padding: 1rem 0;
            border-bottom: 1px solid rgba(228, 215, 215, 0.1);
        }

        .profile-info:last-child {
            border-bottom: none;
        }

        .profile-info label {
            font-weight: 500;
            margin-right: 1rem;
            color: rgb(251, 251, 251);
        }

        #map {
            height: 400px;
            border-radius: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .form-control {
            border-radius: 8px;
            padding: 0.8rem;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            box-shadow: 0 0 0 0.2rem rgba(3, 76, 9, 0.25);
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .checkbox-group label {
            background: var(--background-color);
            padding: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-group label:hover {
            background: #d5dbdb;
        }

        .table {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .table thead {
            background: var(--primary-color);
            color: white;
        }

        .table th {
            font-weight: 500;
            padding: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success-color);
            border: none;
        }

        .modal {
            backdrop-filter: blur(5px);
        }

        .modal-content {
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
    .status-badge {
        padding: 0.5em 1em;
        border-radius: 20px;
        font-weight: 500;
        text-align: center;
        display: inline-block;
        min-width: 100px;
    }
    
    .status-upcoming {
        background-color: #e3f2fd;
        color: #1976d2;
    }
    
    .status-active {
        background-color: #e8f5e9;
        color: #2e7d32;
    }
    
    .status-completed {
        background-color: #eeeeee;
        color: #616161;
    }
    .volunteer-count {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .status-cancelled {
            background-color: #ffebee;
            color: #c62828;
        }

        .role-badge {
            background: var(--secondary-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 500;
            display: inline-block;
            margin-bottom: 1rem;
        }

        .volunteer-details-modal .modal-header {
            background: var(--primary-color);
            color: white;
        }

        .volunteer-list {
    max-height: 70vh;
    overflow-y: auto;
    padding: 1rem;
}

.volunteer-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    border: 1px solid #dee2e6;
    transition: all 0.3s ease;
}

.volunteer-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.volunteer-info {
    margin-bottom: 1rem;
}

.volunteer-info div {
    font-size: 0.9rem;
}

.badge-award-section {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    margin-top: 1rem;
}
.badge-select {
        flex: 1;
        margin-bottom: 0;
        min-width: 150px;
    }

    .badge-status {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 500;
    text-align: center;
}

    .badge-bronze { background-color: #cd7f32; color: white; }
    .badge-gold { background-color: #ffd700; color: black; }
    .badge-diamond { background-color: #B9F2FF; color: black; }
    .badge-platinum { background-color: #E5E4E2; color: black; }

    .award-btn {
    min-width: 120px;
    transition: all 0.3s ease;
}

.award-btn:disabled {
    background-color: #6c757d;
    cursor: not-allowed;
    opacity: 0.8;
}

.award-btn:disabled:hover {
    transform: none;
}

.award-btn .fa-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Enhance the badge selection area */
.badge-award-section {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    margin-top: 1rem;
}

.badge-select {
    min-width: 200px;
    flex-grow: 1;
}

.text-success {
    color: #198754;
    font-weight: 500;
}

.badge-award-section.awarded .text-success {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem;
}
.badge-award-section.awarded button {
    background-color: #6c757d !important;
    opacity: 0.65;
    pointer-events: none;
    cursor: not-allowed !important;
}

.badge-award-section.awarded select {
    opacity: 0.65;
    pointer-events: none;
    background-color: #e9ecef !important;
}
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    backdrop-filter: blur(5px);
}

.notification-modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: white;
    padding: 2rem;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    z-index: 1001;
    text-align: center;
    max-width: 400px;
    width: 90%;
}

.success-icon {
    font-size: 3rem;
    color: #28a745;
    margin-bottom: 1rem;
}

.notification-modal h4 {
    color: #333;
    margin-bottom: 1rem;
}

.notification-modal p {
    color: #666;
    margin-bottom: 1.5rem;
}

.notification-modal button {
    min-width: 100px;
    padding: 0.5rem 1rem;
}
.buyer-card {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 1rem;
    overflow: hidden;
    transition: transform 0.2s ease-in-out;
}
.buyer-summary {
    padding: 1rem;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    transition: background-color 0.3s;
}
.buyer-summary:hover {
    background: #f0f0f0;
}
.buyer-basic-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}
.buyer-icon {
    width: 40px;
    height: 40px;
    background: #e9ecef;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6c757d;
}

.dropdown-icon {
    transition: transform 0.3s;
}

.dropdown-icon.active {
    transform: rotate(180deg);
}

.buyer-details-expanded {
    padding: 1rem;
    border-top: 1px solid #e9ecef;
    display: none;
}

.buyer-details-expanded.show {
    display: block;
    animation: slideDown 0.3s ease-out;
}

.detail-section {
    margin-bottom: 1rem;
    padding: 0.5rem;
    background: #f8f9fa;
    border-radius: 4px;
}

.detail-section h6 {
    color: #495057;
    margin-bottom: 0.5rem;
}

.purchase-history {
    margin-top: 1rem;
}

.purchase-item {
    padding: 0.5rem;
    border-bottom: 1px solid #e9ecef;
}

.purchase-item:last-child {
    border-bottom: none;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.status-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.875rem;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
}

.status-completed {
    background: #d4edda;
    color: #155724;
}

.buyer-card:hover {
    transform: translateY(-2px);
}


    .buyer-header {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 8px 8px 0 0;
    }

    .buyer-content {
        padding: 1rem;
    }

    .buyer-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .info-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .product-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .product-tag {
        background-color: #e3f2fd;
        color: #1976d2;
        padding: 0.25rem 0.75rem;
        border-radius: 16px;
        font-size: 0.875rem;
    }

    .stats-badge {
        background-color: #f8f9fa;
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .error-message {
        color: #dc3545;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        padding: 1rem;
        border-radius: 4px;
        margin: 1rem 0;
    }

    @media (max-width: 768px) {
        .buyer-info {
            grid-template-columns: 1fr;
        }
    }
    .buyer-card {
    transition: transform 0.2s ease-in-out;
}

.buyer-card:hover {
    transform: translateY(-2px);
}

.buyer-stats .col-6 {
    transition: background-color 0.2s ease-in-out;
}

.buyer-stats .col-6:hover {
    background-color: rgba(0, 0, 0, 0.02);
}

.purchased-products .badge {
    transition: all 0.2s ease-in-out;
}

.purchased-products .badge:hover {
    background-color: var(--bs-primary) !important;
    color: white !important;
}

.refresh-buyers {
    transition: all 0.2s ease-in-out;
}

.refresh-buyers:hover i {
    transform: rotate(180deg);
}

.refresh-buyers i {
    transition: transform 0.5s ease-in-out;
}
</style>
</head>
<body>
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container-fluid">
            <div class="navbar-nav">
                <a class="nav-link" href="#profile"><i class="fas fa-user me-2"></i>Profile</a>
                <a class="nav-link" href="#create-event"><i class="fas fa-calendar-plus me-2"></i>Create Event</a>
                <a class="nav-link" href="#events"><i class="fas fa-list me-2"></i>My Events</a>
                <a class="nav-link" href="{{ url_for('completed_events') }}"><i class="fas fa-list me-2"></i>Event Reports</a>
                <a href="{{ url_for('organiser_feedbacks') }}" class="nav-link">
                    <i class="fas fa-comments"></i>
                    <span>Feedbacks</span>
                </a>
                <a class="nav-link" href="#sell-product"><i class="fas fa-tag me-2"></i>Sell Product</a>
                <a class="nav-link" href="#buyer-details"><i class="fas fa-calendar-alt"></i>  Buyer Details</a>
                <a class="nav-link" href="#donations"><i class="fa-solid fa-hand-holding-dollar"></i> Donations</a>
                <a class="nav-link" href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt me-2"></i>Logout</a>
            </div>
        </div>
    </nav>

    <div class="modal-overlay" id="modalOverlay">
        <div class="notification-modal" id="successModal">
            <i class="fas fa-check-circle success-icon"></i>
            <h4>Product Uploaded Successfully!</h4>
            <p>Your product has been uploaded and is pending admin approval. You will be notified once it's approved.</p>
            <button onclick="closeNotification()" class="btn btn-primary">OK</button>
        </div>
    </div>

    

    <!-- Profile Section -->
    <!-- Profile Section with Role Badge -->
    <div class="container" id="profile">
        <div class="profile-section">
            <div class="role-badge">
                <i class="fas fa-user-shield me-2"></i>{{ session.role|title }}
            </div>
            <h2 class="mb-4">Profile Information</h2>
            <div class="profile-info">
                <i class="fas fa-user"></i>
                <label>Username:</label>
                <span>{{ user.username }}</span>
            </div>
            <div class="profile-info">
                <i class="fas fa-envelope"></i>
                <label>Email:</label>
                <span>{{ user.email }}</span>
            </div>
            <div class="profile-info">
                <i class="fas fa-phone"></i>
                <label>Mobile:</label>
                <span>{{ user.mobile }}</span>
            </div>
        </div>
    </div>

    <!-- Event Creation Section -->
    <div class="container" id="create-event">
        <h2 class="mb-4">Create New Event</h2>
        <form action="{{ url_for('organiser') }}" method="POST" enctype="multipart/form-data">
            <input type="hidden" name="create-event" value="1">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Event Name</label>
                    <input class="form-control" type="text" name="event-name" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Date</label>
                    <input class="form-control" type="date" name="event-date" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Time</label>
                    <input class="form-control" type="time" name="event-time" required>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Event Photo</label>
                    <input class="form-control" type="file" name="event-photo" accept="image">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Number of Volunteers</label>
                    <input class="form-control" type="number" name="volunteers" required>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Salary per Volunteer</label>
                    <input class="form-control" type="number" name="volunteer-salary" required>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Event Location</label>
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="location-input" placeholder="Enter location" required>
                    <button class="btn btn-outline-secondary" type="button" id="search-location">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div id="map"></div>
                <p id="location-display" class="text-muted">Enter a location or click on the map</p>
                <input type="hidden" id="latitude" name="latitude" required>
                <input type="hidden" id="longitude" name="longitude" required>
                <input type="hidden" id="location" name="location" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Event Supplies</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" name="supplies[]" value="food"> Food</label>
                    <label><input type="checkbox" name="supplies[]" value="snacks"> Snacks</label>
                    <label><input type="checkbox" name="supplies[]" value="mask"> Mask</label>
                    <label><input type="checkbox" name="supplies[]" value="gloves"> Gloves</label>
                    <label><input type="checkbox" name="supplies[]" value="reflective-jacket"> Reflective Jacket</label>
                    <label><input type="checkbox" name="supplies[]" value="sanitizer"> Sanitizer</label>
                    <label><input type="checkbox" name="supplies[]" value="bag"> Bag</label>
                </div>
            </div>

            <button type="submit" class="btn btn-success">Create Event</button>
        </form>
    </div>

    <!-- Events List with Enhanced Volunteer Count -->
    <div class="container" id="events">
        <h2 class="mb-4">My Events</h2>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Event Name</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Volunteers</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for event in events %}
                    <tr data-event-id="{{ event.id }}">
                        <td>{{ event.event_name }}</td>
                        <td>{{ event.event_date }}</td>
                        <td>{{ event.event_time }}</td>
                        <td>
                            <div class="volunteer-count" onclick="showVolunteers('{{ event.id }}')" style="cursor: pointer">
                                <i class="fas fa-users"></i>
                                <span>{{ event.joined_volunteers }}/{{ event.num_volunteers }}</span>
                            </div>
                        </td>
                        <td>
                            <span class="status-badge status-{{ event.status|lower }}">
                                {{ event.status }}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <button type="button" 
                                        class="btn btn-sm btn-primary me-2" 
                                        onclick="openEditModal({
                                            id: '{{ event.id }}',
                                            event_name: '{{ event.event_name }}',
                                            event_date: '{{ event.event_date }}',
                                            event_time: '{{ event.event_time }}',
                                            num_volunteers: '{{ event.num_volunteers }}',
                                            salary_per_volunteer: '{{ event.salary_per_volunteer }}',
                                            status: '{{ event.status }}'
                                        })">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button type="button" class="btn btn-sm btn-danger" onclick="confirmDelete('{{ event.id }}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modified Edit Event Modal -->
    <div class="modal fade" id="editEventModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Event</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editEventForm">
                        <input type="hidden" id="editEventId" name="event-id">
                        <div class="mb-3">
                            <label class="form-label">Event Name</label>
                            <input type="text" class="form-control" id="editEventName" name="event-name" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-control" id="editEventDate" name="event-date" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Time</label>
                                <input type="time" class="form-control" id="editEventTime" name="event-time" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Number of Volunteers</label>
                                <input type="number" class="form-control" id="editVolunteers" name="volunteers" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Salary per Volunteer</label>
                                <input type="number" class="form-control" id="editVolunteerSalary" name="volunteer-salary" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Event Status</label>
                            <select class="form-control" id="editEventStatus" name="event-status">
                                <option value="Upcoming">Upcoming</option>
                                <option value="Active">Active</option>
                                <option value="Completed">Completed</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEventChanges()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

 <!-- Modified Volunteer Details Modal -->
 <div class="modal fade" id="volunteerDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Event Volunteers</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="volunteerList" class="volunteer-list">
                    <!-- Volunteers will be loaded here dynamically -->
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this event?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>
</div>

<div class="container" id="sell-product">
    <h2 class="mb-4">Sell Products</h2>
    <div class="row">
        {% if events %}
            {% for event in events %}
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <button class="btn btn-primary mb-3" onclick="showProductForm('{{ event.id }}')">
                            <i class="fas fa-plus me-2"></i>Add Product
                        </button>
                        
                        <div id="sellProductForm{{ event.id }}" class="sell-product-form" style="display: none;">
                            <form action="{{ url_for('upload_product') }}" method="POST" enctype="multipart/form-data" 
                                  class="product-upload-form" onsubmit="handleProductSubmit(event, '{{ event.id }}')">
                                <input type="hidden" name="event_id" value="{{ event.id }}">
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Product Type</label>
                                        <select class="form-select" name="product-type" onchange="toggleProductFields(this)" required>
                                            <option value="">Select Product Type</option>
                                            <option value="wholesale">Wholesale Plastics</option>
                                            <option value="recycled">Recycled Products</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Product Name</label>
                                        <input class="form-control" type="text" name="product-name" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Price (₹)</label>
                                        <input class="form-control" type="number" step="0.01" name="price" required>
                                    </div>
                                </div>
                                
                                <div id="wholesalePlasticsField" class="row mb-3" style="display: none;">
                                    <div class="col-md-6">
                                        <label class="form-label">Wholesale Plastics Quantity (kg)</label>
                                        <input class="form-control" type="number" step="0.1" min="0" name="quantity" id="wholesale-quantity">
                                        <input type="hidden" name="units" value="kg" id="wholesale-units">
                                    </div>
                                </div>
                                
                                <div id="recycledProductsField" class="row mb-3" style="display: none;">
                                    <div class="col-md-6">
                                        <label class="form-label">Recycled Products Quantity (units)</label>
                                        <input class="form-control" type="number" min="0" name="quantity" id="recycled-quantity">
                                        <input type="hidden" name="units" value="units" id="recycled-units">
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Product Description</label>
                                    <textarea class="form-control" name="description" rows="3" required></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Upload Product Image</label>
                                    <input class="form-control" type="file" name="product-image" accept="image/*" required>
                                </div>
                                <div class="form-feedback mb-3 d-none">
                                    <div class="alert alert-danger"></div>
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-success">Upload Product</button>
                                    <button type="button" class="btn btn-secondary" onclick="hideProductForm('{{ event.id }}')">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i>No events available for selling products. Please create an event first.
                </div>
            </div>
        {% endif %}
    </div>
</div>

<div class="container" id="buyer-details">
    <h2 class="mb-4">Buyer Details</h2>
    <div class="buyer-list">
        {% if buyers %}
        {% for buyer in buyers[:5] %}
            <div class="buyer-card">
                <div class="buyer-header">
                    <h3>{{ buyer.buyer_name }}</h3>
                </div>
                <div class="buyer-content">
                    <div class="buyer-info">
                        <div class="info-item">
                            <i class="fas fa-envelope"></i> <span>{{ buyer.buyer_email }}</span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-phone"></i> <span>{{ buyer.buyer_mobile }}</span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-box"></i> <span>Product: {{ buyer.product_name }}</span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-shopping-cart"></i> <span>Quantity: {{ buyer.quantity }}</span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-calendar-alt"></i> <span>Purchase Date: {{ buyer.purchase_date }}</span>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
        
        {% if buyers|length > 5 %}
            <div class="text-center mb-4">
                <button class="btn btn-primary" onclick="toggleAllBuyers(this)">
                    <i class="fas fa-chevron-down me-2"></i>
                    <span>Show All Buyers</span>
                </button>
            </div>
            
            <div id="allBuyersList" style="display: none;">
                {% for buyer in buyers[5:] %}
                    <div class="buyer-card">
                        <div class="buyer-header">
                            <h3>{{ buyer.buyer_name }}</h3>
                        </div>
                        <div class="buyer-content">
                            <div class="buyer-info">
                                <div class="info-item">
                                    <i class="fas fa-envelope"></i> <span>{{ buyer.buyer_email }}</span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-phone"></i> <span>{{ buyer.buyer_mobile }}</span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-box"></i> <span>Product: {{ buyer.product_name }}</span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-shopping-cart"></i> <span>Quantity: {{ buyer.quantity }}</span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-calendar-alt"></i> <span>Purchase Date: {{ buyer.purchase_date }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        {% else %}
            <div class="alert alert-warning text-center">
                <i class="fas fa-exclamation-circle"></i> No buyers found.
            </div>
        {% endif %}
    </div>
</div>

    <div class="container mt-5" id="donations">
        <h2>Donor Details</h2>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Amount (₹)</th>
                    <th>Date</th>
                   <!---- <th>Status</th>-->
                </tr>
            </thead>
            <tbody>
                {% if donors %}
                    {% for donor in donors %}
                        <tr>
                            <td>{{ donor.donor_name }}</td>
                            <td>{{ donor.donor_email }}</td>
                            <td>{{ donor.amount }}</td>
                            <td>{{ donor.donation_date.strftime('%Y-%m-%d %H:%M:%S') if donor.donation_date else 'N/A' }}</td>
                        <!---    <td>{{ donor.status }}</td>-->
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="5" class="text-center">No donors found.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>





<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Map initialization with default coordinates for Madurai
let map = L.map('map').setView([9.939093, 78.119775], 13);
let marker;
let hasSetLocation = false;  // Flag to track if location has been set

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

function setMarker(lat, lng) {
    if (marker) {
        marker.setLatLng([lat, lng]);
    } else {
        marker = L.marker([lat, lng]).addTo(map);
    }
    // Set the form values
    document.getElementById('latitude').value = lat;
    document.getElementById('longitude').value = lng;
    hasSetLocation = true;
}

// Initialize marker at Madurai with default coordinates
setMarker(9.939093, 78.119775);

// Reverse geocoding function
async function reverseGeocode(lat, lng) {
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
        const data = await response.json();
        const location = data.display_name;
        document.getElementById('location-display').textContent = "Selected location: " + location;
        document.getElementById('location').value = location;
    } catch (error) {
        console.error('Error getting location:', error);
        document.getElementById('location-display').textContent = "Error getting location details";
    }
}

// Map click handler
map.on('click', function(e) {
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;
    setMarker(lat, lng);
    reverseGeocode(lat, lng);
});

// Form submission handler
document.querySelector('form').addEventListener('submit', async function(event) {
    event.preventDefault();
    
    // Validate form fields
    const requiredFields = ['event-name', 'event-date', 'event-time', 'volunteers', 'volunteer-salary'];
    for (const field of requiredFields) {
        const input = this.querySelector(`[name="${field}"]`);
        if (!input.value) {
            showAlert(`Please fill in the ${field.replace('-', ' ')}`, 'danger');
            return;
        }
    }

    // Validate location selection
    if (!hasSetLocation) {
        showAlert('Please select a location on the map', 'danger');
        return;
    }

    // Create FormData and submit
    const formData = new FormData(this);
    try {
        const response = await fetch(this.action, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert(result.message, 'success');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showAlert(result.message || 'Error creating event', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('Error creating event', 'danger');
    }
});
// Modal handling
const editEventModal = new bootstrap.Modal(document.getElementById('editEventModal'));
const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));


// Open edit modal with event data
function openEditModal(event) {
            if (!event || !event.id) {
                console.error('Invalid event data');
                return;
            }
            
            currentEventId = event.id;
            
            const setFormValue = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.value = value || '';
                }
            };

            setFormValue('editEventId', event.id);
            setFormValue('editEventName', event.event_name);
            setFormValue('editEventDate', event.event_date);
            setFormValue('editEventTime', event.event_time);
            setFormValue('editVolunteers', event.num_volunteers);
            setFormValue('editVolunteerSalary', event.salary_per_volunteer);
            setFormValue('editEventStatus', event.status);
            
            editEventModal.show();
        }

// Modified saveEventChanges function
async function saveEventChanges() {
    const formData = new FormData(document.getElementById('editEventForm'));
    formData.append('action', 'edit_event');
    formData.append('event_id', currentEventId);
    
    const submitButton = document.querySelector('#editEventModal .btn-primary');
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    
    try {
        const response = await fetch('/organiser', {
            method: 'POST',
            body: formData,
            headers: {
                'Accept': 'application/json'  // Explicitly request JSON response
            }
        });
        
        // Check if response is ok before trying to parse JSON
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Received non-JSON response from server');
        }
        
        const data = await response.json();
        
        if (data.success) {
            // Hide modal
            const editModal = bootstrap.Modal.getInstance(document.getElementById('editEventModal'));
            editModal.hide();
            
            // Show success message
            showAlert(data.message || 'Event updated successfully!', 'success');
            
            // Reload page after short delay
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            throw new Error(data.message || 'Failed to update event');
        }
    } catch (error) {
        console.error('Error updating event:', error);
        showAlert(error.message || 'Error updating event. Please try again.', 'danger');
    } finally {
        // Reset button state
        submitButton.disabled = false;
        submitButton.innerHTML = 'Save Changes';
    }
}

// Function to delete the event
    async function deleteEvent() {
        if (!currentEventId) {
            console.error('No event selected for deletion');
            showAlert('No event selected for deletion', 'danger');
            return;
        }

        const formData = new FormData();
        formData.append('action', 'delete_event');
        formData.append('event_id', currentEventId);

        try {
            const response = await fetch('/organiser', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                new bootstrap.Modal(document.getElementById('deleteConfirmModal')).hide();

                const eventRow = document.querySelector(`tr[data-event-id="${currentEventId}"]`);
                if (eventRow) {
                    eventRow.remove();
                }

                showAlert('Event deleted successfully', 'success');
                currentEventId = null;
            } else {
                throw new Error(data.message || 'Failed to delete event');
            }
        } catch (error) {
            console.error('Error deleting event:', error);
            showAlert(error.message || 'Error deleting event', 'danger');
        }
    }

    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.role = 'alert';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

        document.body.appendChild(alertDiv);

        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }
      // Handle badge award UI updates
function updateBadgeUI(volunteerId, badgeType, success = true) {
    const badgeSection = document.getElementById(`badge-section-${volunteerId}`);
    if (!badgeSection) return;

    if (success) {
        badgeSection.outerHTML = `
            <div class="badge-award-section awarded" id="badge-section-${volunteerId}">
                <div class="badge-status badge-${badgeType.toLowerCase()} me-2">
                    <i class="fas fa-medal me-2"></i>${badgeType} Badge
                </div>
                <span class="text-success">
                    <i class="fas fa-check-circle me-2"></i>Awarded
                </span>
            </div>`;
    }
}  
// Modified showVolunteers function to include badge info
async function showVolunteers(eventId) {
    try {
        const response = await fetch(`/get_event_volunteers/${eventId}`);
        const data = await response.json();
        
        const eventRow = document.querySelector(`tr[data-event-id="${eventId}"]`);
        const eventStatus = eventRow.querySelector('.status-badge').textContent.trim();
        const isCompleted = eventStatus === 'Completed';
        
        const volunteersWithBadgeStatus = data.volunteers.map(volunteer => ({
            ...volunteer,
            has_badge: localStorage.getItem(`badge_${volunteer.id}_${eventId}`) === 'awarded'
        }));

        const volunteerList = document.getElementById('volunteerList');
        volunteerList.innerHTML = volunteersWithBadgeStatus.length ? 
            volunteersWithBadgeStatus.map(v => createVolunteerCard(v, eventId, isCompleted)).join('') :
            '<div class="text-center p-4">No volunteers yet</div>';

        new bootstrap.Modal(document.getElementById('volunteerDetailsModal')).show();
    } catch (error) {
        console.error('Error:', error);
        showAlert('Error fetching volunteers', 'danger');
    }
}
async function awardBadge(volunteerId, eventId, button) {
    const selectElement = document.getElementById(`badge-select-${volunteerId}`);
    if (!selectElement?.value) {
        showAlert('Please select a badge type', 'warning');
        return;
    }

    const badgeType = selectElement.value;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Awarding...';
    
    try {
        const response = await fetch('/award_badge', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                volunteer_id: volunteerId,
                event_id: eventId,
                badge_type: badgeType
            })
        });

        const data = await response.json();
        
        if (data.success) {
            const badgeSection = document.getElementById(`badge-section-${volunteerId}`);
            if (badgeSection) {
                badgeSection.outerHTML = createAwardedBadgeHTML(badgeType);
            }
            showAlert('Badge awarded successfully!', 'success');
        } else {
            throw new Error(data.message || 'Failed to award badge');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert(error.message || 'Error awarding badge', 'danger');
        // Reset button state on error
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-award me-2"></i>Award Badge';
    }
}

function createVolunteerCard(volunteer, eventId, isCompleted) {
    return `
        <div class="volunteer-card">
            <div class="volunteer-info mb-3">
                <h5>${volunteer.username}</h5>
                <div><i class="fas fa-envelope me-2"></i>${volunteer.email}</div>
                <div><i class="fas fa-phone me-2"></i>${volunteer.mobile}</div>
                <div><i class="fas fa-calendar-check me-2"></i>Joined: ${new Date(volunteer.joined_date).toLocaleDateString()}</div>
            </div>
            ${isCompleted ? createBadgeSection(volunteer, eventId) : ''}
        </div>`;
}
function createAwardedBadge(badgeType) {
    return `
        <div class="badge-award-section">
            <div class="badge-status badge-${badgeType.toLowerCase()}">
                <i class="fas fa-medal me-2"></i>${badgeType} Badge
            </div>
            <div class="text-success">
                <i class="fas fa-check-circle me-2"></i>Awarded
            </div>
        </div>`;
}

function createBadgeSelector(volunteerId, eventId) {
    return `
        <div class="badge-award-section" id="badge-section-${volunteerId}">
            <select class="form-select badge-select" id="badge-select-${volunteerId}">
                <option value="">Select Badge</option>
                <option value="Bronze">Bronze Badge</option>
                <option value="Gold">Gold Badge</option>
                <option value="Platinum">Platinum Badge</option>
                <option value="Diamond">Diamond Badge</option>
            </select>
            <button class="btn btn-primary award-btn" onclick="awardBadge('${volunteerId}', '${eventId}', this)">
                <i class="fas fa-award me-2"></i>Award Badge
            </button>
        </div>`;
}

function getBadgeSection(volunteer, eventId, isCompleted) {
    if (!isCompleted) {
        return '';
    }

    if (volunteer.has_badge || volunteer.badge_type) {
        const badgeType = volunteer.badge_type || 'Awarded';
        return `
            <div class="badge-award-section awarded">
                <select class="form-select badge-select" disabled>
                    <option>${badgeType} Badge Awarded</option>
                </select>
                <button class="btn btn-secondary award-btn" disabled style="background-color: #6c757d; cursor: not-allowed;">
                    <i class="fas fa-check-circle me-2"></i>Badge Awarded
                </button>
            </div>`;
    }

    return `
        <div class="badge-award-section" id="badge-section-${volunteer.id}">
            <select class="form-select badge-select" id="badge-select-${volunteer.id}">
                <option value="">Select Badge</option>
                <option value="Bronze">Bronze Badge</option>
                <option value="Gold">Gold Badge</option>
                <option value="Platinum">Platinum Badge</option>
                <option value="Diamond">Diamond Badge</option>
            </select>
            <button class="btn btn-primary award-btn" onclick="awardBadge('${volunteer.id}', '${eventId}', this)">
                <i class="fas fa-award me-2"></i>Award Badge
            </button>
        </div>`;
}
// Add this new function after createVolunteerCard
function createDisabledBadgeHTML() {
    return `
        <div class="badge-award-section">
            <select class="form-select badge-select" disabled>
                <option>Badge Already Awarded</option>
            </select>
            <button class="btn btn-secondary award-btn" disabled>
                <i class="fas fa-award me-2"></i>Already Awarded
            </button>
        </div>`;
}

function createAwardedBadgeHTML(badgeType) {
    return `
        <div class="badge-award-section awarded">
            <div class="badge-status badge-${badgeType.toLowerCase()} me-2">
                <i class="fas fa-medal me-2"></i>${badgeType} Badge
            </div>
            <span class="text-success">
                <i class="fas fa-check-circle me-2"></i>Awarded
            </span>
        </div>`;
}

function createBadgeSelectionHTML(volunteerId, eventId) {
    return `
        <div class="badge-award-section" id="badge-section-${volunteerId}">
            <select class="form-select badge-select" id="badge-select-${volunteerId}">
                <option value="">Select Badge</option>
                <option value="Bronze">Bronze Badge</option>
                <option value="Gold">Gold Badge</option>
                <option value="Platinum">Platinum Badge</option>
                <option value="Diamond">Diamond Badge</option>
            </select>
            <button class="btn btn-primary award-btn" onclick="awardBadge('${volunteerId}', '${eventId}', this)">
                <i class="fas fa-award me-2"></i>Award Badge
            </button>
        </div>`;
}
function createBadgeSection(volunteer, eventId) {
    if (volunteer.badge_type) {
        return createAwardedBadgeHTML(volunteer.badge_type);
    }
    return createBadgeSelectionHTML(volunteer.id, eventId);
}
// Function to open delete confirmation modal
// Initialize modals and event handlers when the document loads
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the delete confirmation modal
    deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    
    // Add event listeners for modal buttons
    document.getElementById('cancelDeleteBtn').addEventListener('click', function() {
        deleteConfirmModal.hide();
        currentEventId = null;
    });
    
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        handleDeleteEvent();
    });
    
    // Handle modal close events
    document.getElementById('deleteConfirmModal').addEventListener('hidden.bs.modal', function() {
        currentEventId = null;
    });
});

let deleteModal = null;
let currentEventId = null;

// Initialize delete functionality when document loads
document.addEventListener('DOMContentLoaded', function() {
    // Initialize delete modal
    deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    
    // Add event listener for delete confirmation button
    document.querySelector('#deleteConfirmModal .btn-danger').addEventListener('click', deleteEvent);
});

// Function to show delete confirmation modal
function confirmDelete(eventId) {
    if (!eventId) {
        showAlert('Invalid event ID', 'danger');
        return;
    }
    
    currentEventId = eventId;
    deleteModal.show();
}
// Function to close delete modal
function closeDeleteModal() {
    if (deleteModal) {
        deleteModal.hide();
        currentEventId = null;
    }
}

// Function to handle confirmed deletion
async function deleteEvent() {
    if (!currentEventId) {
        showAlert('No event selected for deletion', 'danger');
        return;
    }

    try {
        // Show loading state
        const deleteButton = document.querySelector('#deleteConfirmModal .btn-danger');
        const originalText = deleteButton.innerHTML;
        deleteButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
        deleteButton.disabled = true;

        const formData = new FormData();
        formData.append('action', 'delete_event');
        formData.append('event_id', currentEventId);

        const response = await fetch('/organiser', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (response.ok && data.success) {
            // Close the modal
            deleteModal.hide();
            
            // Remove the event row from the table
            const eventRow = document.querySelector(`tr[data-event-id="${currentEventId}"]`);
            if (eventRow) {
                eventRow.remove();
            }
            
            showAlert('Event deleted successfully', 'success');
        } else {
            throw new Error(data.message || 'Failed to delete event');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert(error.message || 'Error deleting event. Please try again.', 'danger');
    } finally {
        // Reset button state
        const deleteButton = document.querySelector('#deleteConfirmModal .btn-danger');
        deleteButton.innerHTML = 'Delete';
        deleteButton.disabled = false;
        currentEventId = null;
    }
}

// Enhanced alert function
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-4`;
    alertDiv.style.zIndex = '9999';
    alertDiv.role = 'alert';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}


// Initialize tooltips
const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
});


async function searchLocation(query) {
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        if (data.length > 0) {
            const location = data[0];
            const lat = parseFloat(location.lat);
            const lng = parseFloat(location.lon);
            
            // Update map and marker
            map.setView([lat, lng], 13);
            setMarker(lat, lng);
            
            // Update form values
            document.getElementById('location-input').value = location.display_name;
            document.getElementById('location-display').textContent = "Selected location: " + location.display_name;
            document.getElementById('location').value = location.display_name;
            
            return true;
        } else {
            showAlert('Location not found', 'warning');
            return false;
        }
    } catch (error) {
        console.error('Error searching location:', error);
        showAlert('Error searching location', 'danger');
        return false;
    }
}

// Add event listener for location search button
document.getElementById('search-location').addEventListener('click', async () => {
    const query = document.getElementById('location-input').value;
    if (query) {
        await searchLocation(query);
    }
});

// Add event listener for location input enter key
document.getElementById('location-input').addEventListener('keypress', async (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        const query = e.target.value;
        if (query) {
            await searchLocation(query);
        }
    }
});

// Modify existing map click handler to update input field
map.on('click', async function(e) {
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;
    setMarker(lat, lng);
    
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
        const data = await response.json();
        const location = data.display_name;
        
        document.getElementById('location-input').value = location;
        document.getElementById('location-display').textContent = "Selected location: " + location;
        document.getElementById('location').value = location;
    } catch (error) {
        console.error('Error getting location:', error);
        document.getElementById('location-display').textContent = "Error getting location details";
    }
});

// Form validation
document.querySelectorAll('form').forEach(form => {
    form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        form.classList.add('was-validated');
    });
});


function toggleProductForm(eventId) {
            const form = document.getElementById(`sellProductForm${eventId}`);
            if (form.style.display === 'none' || !form.style.display) {
                form.style.display = 'block';
            } else {
                form.style.display = 'none';
            }
        }
       function showProductForm(eventId) {
            // Hide all other forms first
            document.querySelectorAll('.sell-product-form').forEach(form => {
                form.style.display = 'none';
            });
            
            // Show the selected form
            const form = document.getElementById(`sellProductForm${eventId}`);
            if (form) {
                form.style.display = 'block';
                form.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function hideProductForm(eventId) {
            const form = document.getElementById(`sellProductForm${eventId}`);
            if (form) {
                form.style.display = 'none';
            }
        }

        // Add event listeners when the document loads
        document.addEventListener('DOMContentLoaded', function() {
            // Add submit handlers to all product forms
            document.querySelectorAll('.product-upload-form').forEach(form => {
                form.addEventListener('submit', function(e) {
                    const submitButton = this.querySelector('button[type="submit"]');
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading...';
                });
            });
        });

        function showNotification() {
            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById('successModal').style.display = 'block';
        }

        function closeNotification() {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('successModal').style.display = 'none';
            // Clear form and hide it after closing notification
            document.querySelectorAll('.product-upload-form').forEach(form => {
                form.reset();
            });
            document.querySelectorAll('.sell-product-form').forEach(form => {
                form.style.display = 'none';
            });
        }

        function showProductForm(eventId) {
    document.querySelectorAll('.sell-product-form').forEach(form => {
        form.style.display = 'none';
    });
    
    const form = document.getElementById(`sellProductForm${eventId}`);
    if (form) {
        form.style.display = 'block';
        form.scrollIntoView({ behavior: 'smooth' });
    }
}

function hideProductForm(eventId) {
    const form = document.getElementById(`sellProductForm${eventId}`);
    if (form) {
        const formElement = form.querySelector('form');
        formElement.reset();
        formElement.classList.remove('was-validated');
        formElement.querySelectorAll('.form-control').forEach(input => {
            input.classList.remove('is-invalid');
        });
        
        // Reset the product type fields
        document.getElementById('wholesalePlasticsField').style.display = 'none';
        document.getElementById('recycledProductsField').style.display = 'none';
        
        // Reset any error messages
        const feedback = form.querySelector('.form-feedback');
        feedback.classList.add('d-none');
        
        // Hide the form
        form.style.display = 'none';
    }
}
function validateProductForm(form) {
    const productType = form.querySelector('[name="product-type"]').value;
    const productName = form.querySelector('[name="product-name"]').value;
    const price = form.querySelector('[name="price"]').value;
    const description = form.querySelector('[name="description"]').value;
    const productImage = form.querySelector('[name="product-image"]').files[0];

    // Basic field validation
    if (!productType || !productName || !price || !description || !productImage) {
        showError(form, 'Please fill in all required fields');
        return false;
    }

    // Price validation
    if (isNaN(price) || parseFloat(price) <= 0) {
        showError(form, 'Please enter a valid price');
        return false;
    }

    // Quantity validation based on product type
    let quantity;
    if (productType === 'wholesale') {
        quantity = document.getElementById('wholesale-quantity').value;
        if (!quantity || isNaN(quantity) || parseFloat(quantity) <= 0) {
            showError(form, 'Please enter a valid quantity in kg');
            return false;
        }
    } else if (productType === 'recycled') {
        quantity = document.getElementById('recycled-quantity').value;
        if (!quantity || isNaN(quantity) || parseInt(quantity) <= 0) {
            showError(form, 'Please enter a valid quantity in units');
            return false;
        }
    }

    return true;
}
function toggleProductFields(select) {
    const wholesalePlasticsField = document.getElementById('wholesalePlasticsField');
    const recycledProductsField = document.getElementById('recycledProductsField');
    
    // Reset quantity fields
    document.getElementById('wholesale-quantity').value = '';
    document.getElementById('recycled-quantity').value = '';
    
    // Reset error messages
    const form = select.closest('form');
    const feedback = form.querySelector('.form-feedback');
    feedback.classList.add('d-none');
    
    if (select.value === 'wholesale') {
        wholesalePlasticsField.style.display = 'block';
        recycledProductsField.style.display = 'none';
    } else if (select.value === 'recycled') {
        wholesalePlasticsField.style.display = 'none';
        recycledProductsField.style.display = 'block';
    } else {
        wholesalePlasticsField.style.display = 'none';
        recycledProductsField.style.display = 'none';
    }
}


async function handleProductSubmit(event, eventId) {
    event.preventDefault();
    const form = event.target;
    
    // Clear previous errors
    const feedback = form.querySelector('.form-feedback');
    feedback.classList.add('d-none');
    
    // Validate form
    if (!validateProductForm(form)) {
        return;
    }
    
    const submitButton = form.querySelector('button[type="submit"]');
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading...';
    
    try {
        const formData = new FormData(form);
        const productType = formData.get('product-type');
        
        // Set the correct quantity value
        if (productType === 'wholesale') {
            const quantity = document.getElementById('wholesale-quantity').value;
            formData.set('quantity', quantity);
            formData.set('units', 'kg');
        } else {
            const quantity = document.getElementById('recycled-quantity').value;
            formData.set('quantity', quantity);
            formData.set('units', 'units');
        }
        
        const response = await fetch(form.action, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification();
            form.reset();
            hideProductForm(eventId);
        } else {
            showError(form, data.message || 'Error uploading product. Please try again.');
        }
    } catch (error) {
        console.error('Error:', error);
        showError(form, 'Error uploading product. Please try again.');
    } finally {
        submitButton.disabled = false;
        submitButton.innerHTML = 'Upload Product';
    }
}


function showError(form, message) {
    const feedback = form.querySelector('.form-feedback');
    const alert = feedback.querySelector('.alert');
    alert.textContent = message;
    feedback.classList.remove('d-none');
    
    // Scroll to error message
    feedback.scrollIntoView({ behavior: 'smooth', block: 'center' });
}


// Initialize form validation on page load
document.addEventListener('DOMContentLoaded', function() {
    // Add submit handlers to all product forms
    document.querySelectorAll('.product-upload-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            const eventId = this.querySelector('[name="event_id"]').value;
            handleProductSubmit(e, eventId);
        });
        
        // Add input validation for numeric fields
        const numericInputs = form.querySelectorAll('input[type="number"]');
        numericInputs.forEach(input => {
            input.addEventListener('input', function() {
                if (this.value < 0) {
                    this.value = 0;
                }
            });
        });
    });
});
function showNotification() {
    document.getElementById('modalOverlay').style.display = 'block';
    document.getElementById('successModal').style.display = 'block';
}

function closeNotification() {
    document.getElementById('modalOverlay').style.display = 'none';
    document.getElementById('successModal').style.display = 'none';
    
    // Reset all forms and their validation states
    document.querySelectorAll('.product-upload-form').forEach(form => {
        form.reset();
        form.classList.remove('was-validated');
        form.querySelectorAll('.form-control').forEach(input => {
            input.classList.remove('is-invalid');
        });
    });
    
    // Hide all product forms
    document.querySelectorAll('.sell-product-form').forEach(form => {
        form.style.display = 'none';
    });
}

document.getElementById('product-type').addEventListener('change', function() {
    const wholesaleField = document.getElementById('wholesalePlasticsField');
    const recycledField = document.getElementById('recycledProductsField');
    
    // Reset all quantity and units inputs
    document.getElementById('wholesale-quantity').value = '';
    document.getElementById('recycled-quantity').value = '';
    document.getElementById('wholesale-units').disabled = true;
    document.getElementById('recycled-units').disabled = true;

    if (this.value === 'wholesale') {
        wholesaleField.style.display = 'block';
        recycledField.style.display = 'none';
        document.getElementById('wholesale-units').disabled = false;
    } else if (this.value === 'recycled') {
        wholesaleField.style.display = 'none';
        recycledField.style.display = 'block';
        document.getElementById('recycled-units').disabled = false;
    } else {
        wholesaleField.style.display = 'none';
        recycledField.style.display = 'none';
    }
});
document.addEventListener("DOMContentLoaded", () => {
    const fetchBuyerDetails = async () => {
        try {
            const response = await fetch('/buyer_details');
            const data = await response.json();
            const container = document.getElementById('buyerDetailsContainer');
            
            if (data.length === 0) {
                container.innerHTML = `<p class="text-muted">No purchases found.</p>`;
                return;
            }

            container.innerHTML = data.map(buyer => `
                <div class="card mb-3 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">${buyer.username}</h5>
                        <h6 class="card-subtitle mb-2 text-muted">${buyer.email}</h6>
                        <p class="card-text">
                            <strong>Products Bought:</strong> ${buyer.products}<br>
                            <strong>Total Spent:</strong> ₹${buyer.total_spent}
                        </p>
                    </div>
                </div>
            `).join('');
        } catch (error) {
            console.error("Failed to load buyer details:", error);
            document.getElementById('buyerDetailsContainer').innerHTML = 
                `<p class="text-danger">Failed to load buyer details. Please try again later.</p>`;
        }
    };

    fetchBuyerDetails();
});
document.addEventListener('DOMContentLoaded', function() {
            loadBuyerDetails();
        });

        async function loadBuyerDetails() {
            const buyersList = document.getElementById('buyersList');
            
            try {
                const response = await fetch('/buyer_details');
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || 'Failed to load buyer details');
                }

                if (!data.buyers || data.buyers.length === 0) {
                    buyersList.innerHTML = `
                        <div class="error-message">
                            <i class="fas fa-users fa-3x mb-3"></i>
                            <p>No buyers found.</p>
                        </div>`;
                    return;
                }

                const initialBuyers = data.buyers.slice(0, 5);
                const remainingBuyers = data.buyers.slice(5);

                buyersList.innerHTML = `
                    ${initialBuyers.map(buyer => createBuyerCard(buyer)).join('')}
                    ${remainingBuyers.length > 0 ? `
                        <button class="show-more-btn" onclick="toggleRemainingBuyers(this)">
                            <i class="fas fa-chevron-down me-2"></i>
                            Show More Buyers (${remainingBuyers.length})
                        </button>
                        <div id="remainingBuyers" style="display: none;">
                            ${remainingBuyers.map(buyer => createBuyerCard(buyer)).join('')}
                        </div>
                    ` : ''}
                `;

                // Add click handlers for buyer cards
                addBuyerCardHandlers();

            } catch (error) {
                console.error('Error:', error);
                buyersList.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle fa-3x mb-3 text-danger"></i>
                        <p class="text-danger">Failed to load buyer details. Please try again later.</p>
                    </div>`;
            }
        }

        function createBuyerCard(buyer) {
            const totalSpent = parseFloat(buyer.total_amount).toLocaleString('en-IN', {
                style: 'currency',
                currency: 'INR'
            });

            return `
                <div class="buyer-card">
                    <div class="buyer-header" onclick="toggleBuyerContent(this)">
                        <div>
                            <h5 class="mb-0">${escapeHtml(buyer.username)}</h5>
                            <small>${escapeHtml(buyer.email)}</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="stats-badge">
                                Total Spent: ${totalSpent}
                            </span>
                            <i class="fas fa-chevron-down toggle-icon ms-3"></i>
                        </div>
                    </div>
                    <div class="buyer-content">
                        <div class="info-grid">
                            <div class="info-item">
                                <i class="fas fa-envelope"></i>
                                <span>${escapeHtml(buyer.email)}</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-phone"></i>
                                <span>${escapeHtml(buyer.mobile)}</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-shopping-cart"></i>
                                <span>Products: ${buyer.total_products}</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-calendar"></i>
                                <span>Last Purchase: ${formatDate(buyer.last_purchase_date)}</span>
                            </div>
                        </div>
                        <div class="purchase-history">
                            <h6 class="mb-3">Products Purchased</h6>
                            <div class="products-list">
                                ${buyer.products.map(product => `
                                    <div class="purchase-item">
                                        <strong>${escapeHtml(product)}</strong>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleBuyerContent(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.toggle-icon');
            
            content.classList.toggle('active');
            icon.classList.toggle('active');
        }

        function toggleRemainingBuyers(button) {
            const remainingBuyers = document.getElementById('remainingBuyers');
            const isExpanded = remainingBuyers.style.display !== 'none';
            
            remainingBuyers.style.display = isExpanded ? 'none' : 'block';
            button.innerHTML = isExpanded ? 
                `<i class="fas fa-chevron-down me-2"></i>Show More Buyers` :
                `<i class="fas fa-chevron-up me-2"></i>Show Less`;
                
            if (!isExpanded) {
                remainingBuyers.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function escapeHtml(unsafe) {
            return unsafe
                ? unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;")
                : 'N/A';
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function addBuyerCardHandlers() {
            document.querySelectorAll('.buyer-header').forEach(header => {
                header.addEventListener('click', () => toggleBuyerContent(header));
            });
        }
        function toggleAllBuyers(button) {
    const allBuyersList = document.getElementById('allBuyersList');
    if (allBuyersList.style.display === 'none') {
        allBuyersList.style.display = 'block';
        button.innerHTML = `<i class="fas fa-chevron-up me-2"></i>Show Less`;
    } else {
        allBuyersList.style.display = 'none';
        button.innerHTML = `<i class="fas fa-chevron-down me-2"></i>Show All Buyers`;
    }
}
</script>
</body>
</html>
